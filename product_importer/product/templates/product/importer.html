<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">  
    <title>Home Page</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
  </head>
  <body style="height: 100vh">
    
    <div class="row d-none">
      <input type="file" name="_file" id='excel-input-file'>
    </div>   
    
    <div id="progress-wrapper">
      <div id="progress-bar" style="background-color: blue; width: 0%;">&nbsp;</div>
      <div id="progress-bar-message"></div>
      <div id="import-summary"></div>
    </div> 
    <div>
      <div id="final-message"></div> 
    </div>
    <div class="container" style="position: relative; top: 50vh; width: 100vw">
      <div class="col-md-12 text-center">
        <button type="button" class="btn btn-primary" id="import-button" 
                onclick="document.getElementById('excel-input-file').click()">
          Import Products
        </button>
        <a href="{% url 'products:product_list' %}" class="btn btn-primary" id="product-list">
          Go to product list page
        </a>
      </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV" crossorigin="anonymous"></script>
  <script>

    $('#product-list').hide();
    (function () {
        var fileInputElm = document.getElementById('excel-input-file');
        fileInputElm.addEventListener('change', uploadFile, false);
    })();

    var task_id = null;
    function uploadFile(e) {
      var files = e.target.files;      
      let formData = new FormData(); 
      formData.append("_file", files[0]);
      $.ajax({
        url: "{% url 'api:file_upload' %}",
        type: 'POST',
        data: formData,
        success: function (data) {
            $('#import-button').hide();
            task_id = data.task_id;
            var url = getProgressUrl();
            getProgressData(url);
        },
        cache: false,
        contentType: false,
        processData: false
      });
    };

    function getProgressUrl() {
      var progressUrl = window.location.origin + "/api/get-import-progress/" + task_id;
      return progressUrl
    }

    function getProgressData (progressUrl) {
      fetch(progressUrl).then(function(response) {
        response.json().then(function(data) {
          // update the appropriate UI components
          if (data.state === "PROGRESS") {
            setProgress(data.state, data.details);
            setTimeout(getProgressData, 500, progressUrl);
          } else if (data.state === "SUCCESS") {
            $("#final-message").text(data.details.message)
            $("#import-summary").text(
              'Imported: ' + data.details.valid_products + 
              ' Rejected: ' + data.details.invalid_products
            );
            $('#product-list').show();
          } else if (data.state === "FAILURE") {
            $('#import-button').show();
            $("#final-message").text(data.details.message)
          } else {
            // Probably in pending state, backend will update state to progress
            // in the second iteration.
            setTimeout(getProgressData, 500, progressUrl);
          }
        });
      });
    }
    
    function updateProgressBar(progressBarElement, progressBarMessageElement, importSummaryElement, progress) {
      progressBarElement.style.width = progress.percent + "%";
      progressBarMessageElement.innerHTML = progress.current + ' of ' + progress.total + ' processed.';
      importSummaryElement.innerHTML = 'Imported: ' + progress.valid_products + ' Rejected: ' + progress.invalid_products;
    }
  
    function setProgress(state, details) {
      var bar = document.getElementById("progress-bar");
      var barMessage = document.getElementById("progress-bar-message");
      var importSummary = document.getElementById("import-summary");
      var total = details.total;
      var done = details.done;
      var valid_products = details.valid_products;
      var invalid_products = details.invalid_products;
      var percent = (done * 100) / total;
      for (var i = 0; i < 11; i++) {
        updateProgressBar(bar, barMessage, importSummary, {
          percent: percent,
          current: done,
          total: total,
          valid_products: valid_products,
          invalid_products: invalid_products
        })
      }
    }
    
  </script>
  <style>
    #progress-bar {
      margin-top: 1em;
    }
  </style>
  </body>
</html>
